<!doctype html>
<html>
	<head>
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.staticfile.org/ionic/1.3.2/css/ionic.css" rel="stylesheet">
		<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.js"></script>
		<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
		<meta charset="utf-8">
		<title >VOLVO日志查看</title>
	</head>
	<body>
	<h2 align="center">VOLVO日志查看</h2>
		<div class="panel-group" id="accordion">
			<div class="panel panel-default">
				<div id="collapseThree" class="panel-collapse collapse ">
					<div class="panel-body" id="checkGroup">
						
					</div>
					<div align="center">
						<button id="bottomLogBtn" type="button" onclick="saveServiceList()"   >确认选择</button>
					</div>
				</div>
				<div class="panel-heading" align="center">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" id="contain_check"
						   href="#collapseThree">
							点击 展开/折叠 模块列表
						</a>
					</h4>
				</div>
			</div>
		</div>
		
		
		<form action="">
			<div align="center">
			<label >请选择对应环境：</label>
				<select id="volvoPart">
				 
				</select>
				<label >请选择对应模块：</label>
				<select id="logType">
				 
				</select>
				
				  
				</select>
				
				<label >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请选择日志行数：</label>
				<select id="logNum">
				  <option value ="100">100</option>
				  <option value ="500" selected>500</option>
				  <option value="1000">1000</option>
				</select>
				<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自动刷新-频率:
				<select id="refreshTime">
				  <option value ="1">1</option>
				  <option value ="3" selected>3</option>
				  <option value="5" >5</option>
				</select>
	
				<label class="toggle toggle-positive">
						<input id="autoreFresh" type="checkbox" name="s">
					<div class="track">
					<div class="handle"></div>
					</div>
				</label>

			</div>
			<br />
			<div align="center">
				<button id="getLogBtn" type="button" onclick="queryLogs()">查看日志</button>
				<button id="returnColorBtn" type="button" onclick="changeColor()"   >反转颜色</button>
				<button id="bottomLogBtn" type="button" onclick="bottomLog()"   >日志滚动最后一行</button>
			</div>
			
			
			
		<!-- 多标签页 -->
		<ul id="myTab" class="nav nav-tabs">
			<li class="active">
				<a href="#home" data-toggle="tab">
					 菜鸟教程
				</a>
			</li>
			<li><a href="#ios" data-toggle="tab">iOS</a></li>
			<li class="dropdown">
				<a href="#" id="myTabDrop1" class="dropdown-toggle" 
				   data-toggle="dropdown">Java 
					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1">
					<li><a href="#jmeter" tabindex="-1" data-toggle="tab">jmeter</a></li>
					<li><a href="#ejb" tabindex="-1" data-toggle="tab">ejb</a></li>
				</ul>
			</li>
		</ul>
		<div id="myTabContent" class="tab-content">
			<div class="tab-pane fade in active" id="home">
				<p>菜鸟教程是一个提供最新的web技术站点，本站免费提供了建站相关的技术文档，帮助广大web技术爱好者快速入门并建立自己的网站。菜鸟先飞早入行——学的不仅是技术，更是梦想。</p>
			</div>
			<div class="tab-pane fade" id="ios">
				<p>iOS 是一个由苹果公司开发和发布的手机操作系统。最初是于 2007 年首次发布 iPhone、iPod Touch 和 Apple 
					TV。iOS 派生自 OS X，它们共享 Darwin 基础。OS X 操作系统是用在苹果电脑上，iOS 是苹果的移动版本。</p>
			</div>
			<div class="tab-pane fade" id="jmeter">
				<p>jMeter 是一款开源的测试软件。它是 100% 纯 Java 应用程序，用于负载和性能测试。</p>
			</div>
			<div class="tab-pane fade" id="ejb">
				<p>Enterprise Java Beans（EJB）是一个创建高度可扩展性和强大企业级应用程序的开发架构，部署在兼容应用程序服务器（比如 JBOSS、Web Logic 等）的 J2EE 上。
				</p>
			</div>
		</div>
		<!-- 多标签页结束 -->	
			
			
		
		<div align="center" >
		<label id="warn"></label>
		<br />
		<label id="packageTime"></label>
		<br />
			<textarea  class="form-control" style="width:95%; height:600px" id="result" rows="20" cols="50" width="100%"> </textarea>
		</div>
		</form>
	</body>
</html>


<script>

	var blackFont = true; // 默认黑色字体
	var token = "";
	var jweToken = "";
	var logType = ""; //日志种类
	var logNum = ""  // 日志行数
	var refreshMission = ""; // 定时刷新
	var checkGroupFlag = false; // 是否成功加载模块选择框
	var volvoPartFlag = false; // 是否成功加载项目选择框
	var volvoPartName = "dev-dms"; // 项目选择的内容，默认dev-dms
	
	var getLogBtnFlag = false; // 是否查看日志

	// 监听ctrl+c，关闭自动刷新
	$(document).unbind('keydown').bind('keydown', function(e){ 
		if(e.ctrlKey && e.keyCode  == 67) { 
			if(refreshMission!=""){
				$("#autoreFresh").click();
				refreshLogStop();
				return true;
			}
		}
	});


	$(document).ready(function(){
		checkIE(); // 检查是否是IE浏览器
		getToken(); // 查询日志
		// 单选自动触发
		$("#autoreFresh").change(function() { 
			if($("#autoreFresh").is(':checked')){
				refreshLogStart();
			}else{
				refreshLogStop();
			}
		});
		
	});
	
	$("#volvoPart").change(function(){
		$("#logType").empty();
		checkGroupFlag = false;
		volvoPartFlag = false;
		getToken(); // 查询日志
	});

	/*确认选择*/
	function saveServiceList() {
		var serviceMap = new Array();
		var select = $("#logType");
		select.empty();
		var index = 0;
		$(":checked",$("#collapseThree")).each(function () {
			var title = $(this).attr("id");
			$("#logType").append("<option value='"+title+"'>"+title+"</option>"); 
			serviceMap[index] = title;
			index ++;
		});
		var map = new Map();
		map.set($("#volvoPart").val(),serviceMap);
		setCookie($("#volvoPart").val(),JSON.stringify(serviceMap),7);
		$('#collapseThree').collapse('hide');		
	}


	/*查询日志*/
	function queryLogs() {
		if($("#logType").val() =='' || $("#logType").val()==null || $("#logType").val()==undefined){ 
			alert("请选择日志种类！") ; 
			return;
		}
		getLogBtnFlag = true;
		getToken();
	}

	/*日志紧贴最后一行*/
	function bottomLog() {
		var height=$("#result")[0].scrollHeight;
		$("#result").scrollTop(height);
	}
	
	/*自动刷新log*/
	function refreshLogStart() {
		console.log("开启自动刷新");
		$("#warn").text("=======================正.在.自.动.刷.新（再次点击按钮或Ctrl+C即可停止）====================").css("color","#ff0000");
		$("#getLogBtn").attr("disabled","disabled");
		refreshMission = setInterval(function(){
			queryLogs();
		},1000*parseInt($("#refreshTime").val()));
		
	}
	/*关闭自动刷新log*/	
	function refreshLogStop() {
		clearInterval(refreshMission);
		refreshMission = "";
		console.log("关闭自动刷新");
		$("#getLogBtn").removeAttr("disabled");
		$("#warn").text("");
	}
	/*反转颜色*/	
	function changeColor() {
		if(blackFont==true){
			$("#result").css("background-color","Black");
			$("#result").css("color","#FFFFFF");
		}else{
			$("#result").css("background-color","White");
			$("#result").css("color","#000000");
		}
		blackFont = !blackFont;
	}
	

	/*判断是否IE*/
	function checkIE() {
		if (window.ActiveXObject || "ActiveXObject" in window){
		}else{alert("注意：\n请用IE浏览器或兼容模式使用此工具! \n（部分浏览器兼容性会失效）")}
	}

	
	
	/*获取Token*/
	function getToken() {
		console.log("-----开始获取Token------");
		checkIE();
		logNum =  parseInt("2000000000")+ parseInt($("#logNum").val()) ;
		var getTokenHttp = new XMLHttpRequest();
		getTokenHttp.open('GET', 'https://newbie-test-login.digitalvolvo.com/k8sdashboard/api/v1/csrftoken/login?ran=' + Math.random(), true);
		getTokenHttp.send();
		getTokenHttp.onreadystatechange = function () {
			if (getTokenHttp.readyState == 4 && getTokenHttp.status == 200) {
				var tokenResult = getTokenHttp.responseText;
				var tokenJson = JSON.parse(tokenResult);
				token=tokenJson.token;
				console.log("token："+token);
				console.log("-----获取Token成功------token："+token);
				getJweTokenHttp();
			}else{
				console.log("-----获取Token失败------");
				token="FALSE";
			}
		};
	}
	
	/*获取唯一JweToken*/
	function getJweTokenHttp() {
		console.log("-----开始获取jweToken：------");
		var getJweTokenHttp = new XMLHttpRequest();
			getJweTokenHttp.open('POST', 'https://newbie-test-login.digitalvolvo.com/k8sdashboard/api/v1/login?ran=' + Math.random(), true); 
			getJweTokenHttp.setRequestHeader("Content-type","application/json");
			getJweTokenHttp.setRequestHeader("Host","newbie-test-login.digitalvolvo.com");
			getJweTokenHttp.setRequestHeader("Origin","https://newbie-test-login.digitalvolvo.com");
			getJweTokenHttp.setRequestHeader("Referer","https://newbie-test-login.digitalvolvo.com/k8sdashboard/");
			getJweTokenHttp.setRequestHeader("Sec-Fetch-Mode","cors");
			getJweTokenHttp.setRequestHeader("Sec-Fetch-Site","same-origin");
			getJweTokenHttp.setRequestHeader("X-CSRF-TOKEN:",token);
			getJweTokenHttp.send('{"token":"eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yaW5nIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InZzcy1yZWFkLXRva2VuLTZkYmJkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InZzcy1yZWFkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzg1MTg1NzItODZlYi0xMWVhLWIyN2YtY2EzNDY0YjI0ZmMxIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Om1vbml0b3Jpbmc6dnNzLXJlYWQifQ.LHPNPjmLvoXl_YXcvGrPEMGO2hJC-VsrvBE6QhE21M_mEeuVqbuDbZh47wDlCjjGmiXqaWTpsgZICFVV2sF8FYGWo_4KD0zDswbNT-V0ST3YAwxhUb0yCrnkwv3A8Q5XZ38lsagJlDdGKPHxSuvJuHFw3t0Knn8u4pr5x_HKOxtKKYhSiIOgx0LgPyP0-cftCbzbP8lRQn5JtOTtlZfwTg2v_MkFl0Z1Vjy3l64Mlarij4bxrlH0RcZzX_GbK-mWA0R8PQsIgiDC8avD1oo6yeJ7eyUf0WUpWVLuze_MAPqj3jCuNahOVkVKvmzB0SUpG0RYR_Pz9ihlH21cAO7O-A"}');//发送请求 将情头体写在send中
			getJweTokenHttp.onreadystatechange = function () {
			if (getJweTokenHttp.readyState == 4 && getJweTokenHttp.status == 200) {
				var jweTokenResult = getJweTokenHttp.responseText;
				var jweTokenJson = JSON.parse(jweTokenResult);
				jweToken = jweTokenJson.jweToken;
				console.log("-----获取jweToken：成功------jweToken：："+jweToken);
				// 判断是否需要重新加载下拉框
				if(volvoPartFlag==false){
					getVolvoPart(); // 加载项目下拉框
				}
				getDmsServerName();
			}
		};
	}
		
	/*获取对应项目名称*/
	function getVolvoPart() {
		console.log("-----开始加载项目下拉框：------");
		var httpRequest = new XMLHttpRequest();
		httpRequest.open('GET', 'https://newbie-test-login.digitalvolvo.com/k8sdashboard/api/v1/namespace', true);
		httpRequest.setRequestHeader("jweToken",jweToken);
		httpRequest.send();
		httpRequest.onreadystatechange = function () {
			if (httpRequest.readyState == 4 && httpRequest.status == 200) {
				$("#volvoPart").empty();
				var Result = httpRequest.responseText;
				var dmsServerJson = JSON.parse(Result);
				for (var i = 0; i < dmsServerJson.namespaces.length; i++) { // 生成复选框
					$("#volvoPart").append("<option value='"+dmsServerJson.namespaces[i].objectMeta.name+"'>"+dmsServerJson.namespaces[i].objectMeta.name+"</option>"); 
				}
				$("#volvoPart").val(volvoPartName); // 默认dev-dms项目
				volvoPartFlag = true; // 项目名称，只需要打开页面加载一次就好
				console.log("-----项目下拉框加载成功------");
			}
		};
	}
	
	/*获取对应模块名称*/
	function getDmsServerName() {
		console.log("-----开始获取模块名称：------");
		volvoPartName = isStringNull($("#volvoPart").val()) ? volvoPartName : $("#volvoPart").val();
		var httpRequest = new XMLHttpRequest();
		httpRequest.open('GET', 'https://newbie-test-login.digitalvolvo.com/k8sdashboard/api/v1/pod/'+volvoPartName+'?itemsPerPage=200&page=1&ran=' + Math.random()+'&sortBy=d,creationTimestamp', true);
		httpRequest.setRequestHeader("jweToken",jweToken);
		httpRequest.send();
		httpRequest.onreadystatechange = function () {
			if (httpRequest.readyState == 4 && httpRequest.status == 200) {
				var Result = httpRequest.responseText;
				var dmsServerJson = JSON.parse(Result);
				var _obj = {};
				if(checkGroupFlag==false){ // 加载下拉框
					console.log("-----开始加载模块勾选框：------");
					var innerHtml = ""
					for (var i = 0; i < dmsServerJson.pods.length; i++) { // 生成复选框
						innerHtml += ' <div class="col-xs-2"><input type="checkbox" id="'+dmsServerJson.pods[i].objectMeta.labels.app+'" >  '+dmsServerJson.pods[i].objectMeta.labels.app+"</div>";
					}
					$("#checkGroup").html(innerHtml);
					checkGroupFlag = true; // 复选框生成
					$('#collapseThree').collapse('show');
					// 加载cookie
					var serviceList = getCookie(volvoPartName);
					$("#logType").empty();
					$('input[type="checkbox"]',$("#checkGroup")).each(function () {
						for(var i = 0;i<serviceList.length;i++){
							var title = $(this).attr("id");
							if(serviceList[i]==title){
								$(this).prop('checked',true);
								$("#logType").append("<option value='"+title+"'>"+title+"</option>"); 
							}
						}
					});
					console.log("-----模块勾选框加载成功------");
				}
				if(getLogBtnFlag == true){ // 如果是查看日志，需要对应获取对应key值
					console.log("-----开始查询------");
					for (var i = 0; i < dmsServerJson.pods.length; i++) { // 生成复选框
						if( dmsServerJson.pods[i].objectMeta.labels.app == $("#logType").val()){
								logType = dmsServerJson.pods[i].objectMeta.name;
						}
					}
					console.log("-----模块对应key获取结束------");
					getLogs();
				}
				
			}
		};
	}		
	
	
	/*获取日志*/
	function getLogs() {
		console.log("-----开始获取模块对应日志------");
		var httpRequest = new XMLHttpRequest();
		httpRequest.open('GET', 'https://newbie-test-login.digitalvolvo.com/k8sdashboard/api/v1/log/'+volvoPartName+'/'+logType+'/'+$("#logType").val()+'?logFilePosition=end&referenceTimestamp=newest&referenceLineNum=0&offsetFrom=2000000000&offsetTo='+logNum+'&previous=false&ran=' + Math.random(), true);
		httpRequest.setRequestHeader("jweToken",jweToken);
		httpRequest.send();
		httpRequest.onreadystatechange = function () {
			if (httpRequest.readyState == 4 && httpRequest.status == 200) {
				var Result = httpRequest.responseText;
				var logsJson = JSON.parse(Result);
				var logHistory = "";
				for (var i = 0; i < logsJson.logs.length; i++) {
					logHistory +=logsJson.logs[i].content+"\n";
				}
				$("#result").val(logHistory);
				logHistory = "";
				
			}
		};
		clean();
		getLogBtnFlag = false; //查询结束
		console.log("-----开始获取模块对应日志------");
	}
	

	
	/*工具类-初始化变量*/
	function clean() {
		var token = "";
		var jweToken = "";
		console.log("变量已清理");
	}
	
	/*工具类-判断字符串是否是空*/
	function isStringNull(value){
		if(value==undefined||$.trim(value)==""||$.trim(value)=="null"){
			return true;
		}
		return false;
	}
	/*工具类-设置cookie*/
	function setCookie(cname,cvalue,exdays){
		var d = new Date();
		d.setTime(d.getTime()+(exdays*24*60*60*1000));
		var expires = "expires="+d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
		var ca = document.cookie.split(';');
	}
	/*工具类-读取cookie*/
	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i=0; i<ca.length; i++) {
			var c = ca[i].trim();
			if (c.indexOf(name)==0) return JSON.parse(c.substring(name.length,c.length));
		}
		return "";
	}
	/*工具类-删除cookie*/
	function delCookie(cname) {
		document.cookie = ""+cname+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
	}
 



</script>